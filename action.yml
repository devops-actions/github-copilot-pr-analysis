name: 'PR Analysis with Charts'
description: 'Run PR analysis and generate Mermaid charts'
inputs:
  github_token:
    description: 'GitHub token with repo and pull-requests read permissions'
    required: true
  output_format:
    description: 'Output format (json or csv)'
    required: false
    default: 'json'
  analyze_all_repos:
    description: 'Analyze all repositories'
    required: false
    default: 'true'
  clean_cache:
    description: 'Clean the cache and start fresh'
    required: false
    default: 'false'
  skipped_orgs:
    description: 'Organizations to skip during analysis. Multiline input with one entry per line. Supports simple format (skip entire org) or selective format (org-name:include:repo1,repo2)'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Set up Node.js
      uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ${{ github.action_path }}/package-lock.json

    - name: Install dependencies
      shell: bash
      run: npm ci
      working-directory: ${{ github.action_path }}

    - name: Run PR analysis
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
        OUTPUT_FORMAT: ${{ inputs.output_format }}
        ANALYZE_ALL_REPOS: ${{ inputs.analyze_all_repos }}
        CLEAN_CACHE: ${{ inputs.clean_cache }}
        SKIPPED_ORGS: ${{ inputs.skipped_orgs }}
      run: npm run analyze
      working-directory: ${{ github.action_path }}

    - name: Generate Mermaid Charts
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: npm run charts
      working-directory: ${{ github.action_path }}
